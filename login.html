<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… VIP Ø§Ù„Ø¢Ù…Ù† - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            font-family: 'Segoe UI', 'Tahoma', 'Geneva', 'Verdana', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(to right, #3b82f6, #2563eb);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(to right, #10b981, #059669);
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(to right, #ef4444, #dc2626);
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(220, 38, 38, 0.4);
        }
        
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .step-indicator {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }
        
        .step-indicator.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
            transform: scale(1.1);
        }
        
        .step-indicator.completed {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-connected {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .status-disconnected {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .status-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        .status-blocked {
            background: #fee2e2;
            color: #7f1d1d;
            border: 1px solid #fecaca;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .phone-input {
            direction: ltr;
            text-align: center;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
        
        .blocked-message {
            background: linear-gradient(to right, #fee2e2, #fecaca);
            border-right: 4px solid #dc2626;
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .security-chip {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .fingerprint {
            font-family: monospace;
            font-size: 0.7rem;
            color: #6b7280;
            direction: ltr;
            text-align: left;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        .toast.success { border-right: 4px solid #10b981; }
        .toast.error { border-right: 4px solid #ef4444; }
        .toast.warning { border-right: 4px solid #f59e0b; }
        .toast.info { border-right: 4px solid #3b82f6; }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4 min-h-screen">
    <div class="w-full max-w-md mx-auto">
        <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… -->
        <div class="text-center mb-8 slide-in">
            <div class="inline-block p-4 bg-white/20 backdrop-blur-sm rounded-2xl mb-4">
                <i class="fas fa-shield-alt text-white text-4xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">Ù†Ø¸Ø§Ù… VIP Ø§Ù„Ø¢Ù…Ù†</h1>
            <p class="text-blue-100 opacity-90">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©</p>
        </div>

        <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div class="card rounded-2xl shadow-2xl p-6 mb-6">
            <!-- Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… -->
            <div class="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-gray-300" id="system-dot"></div>
                        <span class="text-sm font-medium text-gray-700" id="system-text">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...</span>
                    </div>
                    <div id="system-badge" class="status-badge">...</div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 text-xs">
                    <div class="flex items-center justify-between p-2 bg-white rounded-lg">
                        <span class="text-gray-600">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</span>
                        <span id="account-status" class="font-medium">...</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-white rounded-lg">
                        <span class="text-gray-600">Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</span>
                        <span id="sessions-count" class="font-medium">0</span>
                    </div>
                </div>
                
                <!-- Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² -->
                <div class="mt-3 flex items-center justify-between">
                    <span class="text-xs text-gray-500">Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²:</span>
                    <span id="device-fingerprint" class="fingerprint"></span>
                </div>
            </div>

            <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù… -->
            <div class="flex items-center justify-center mb-8">
                <div class="flex items-center">
                    <div class="step-indicator active" id="step1">
                        <span>1</span>
                    </div>
                    <div class="w-20 h-1 bg-gray-300 mx-2"></div>
                    <div class="step-indicator" id="step2">
                        <span>2</span>
                    </div>
                </div>
            </div>

            <!-- Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø­Ø¸Ø± -->
            <div id="blocked-template" class="hidden">
                <div class="blocked-message p-4 rounded-xl mb-4">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-ban text-red-600 text-xl mt-1"></i>
                        <div>
                            <h3 class="font-bold text-red-800 mb-1">ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¤Ù‚ØªØ§Ù‹</h3>
                            <p class="text-sm text-red-700 mb-2" id="block-reason"></p>
                            <p class="text-xs text-red-600">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ <span id="block-time">30</span> Ø¯Ù‚ÙŠÙ‚Ø©</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… -->
            <div id="step1-content" class="step-content">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-phone-alt text-blue-600 text-2xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ</h2>
                    <p class="text-gray-600">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ VIP Ø¢Ù…Ù† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ</p>
                </div>

                <div class="space-y-4">
                    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© -->
                    <div>
                        <label class="block text-gray-700 mb-2 font-medium">
                            <i class="fas fa-globe-asia text-blue-500 ml-2"></i>
                            Ø§Ø®ØªØ± Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©
                        </label>
                        <div class="grid grid-cols-2 gap-3">
                            <button type="button" id="btn-972" 
                                    class="country-btn active border-blue-500 bg-blue-50" 
                                    onclick="selectCountry('972')">
                                <span class="text-lg"></span>
                                <span class="font-bold">+972</span>
                                <span class="text-xs text-gray-600">ÙÙ„Ø³Ø·ÙŠÙ†</span>
                            </button>
                            <button type="button" id="btn-970" 
                                    class="country-btn border-gray-300 bg-gray-50" 
                                    onclick="selectCountry('970')">
                                <span class="text-lg"></span>
                                <span class="font-bold">+970</span>
                                <span class="text-xs text-gray-600">ÙÙ„Ø³Ø·ÙŠÙ†</span>
                            </button>
                        </div>
                    </div>

                    <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… -->
                    <div>
                        <label class="block text-gray-700 mb-2 font-medium">
                            <i class="fas fa-mobile-alt text-blue-500 ml-2"></i>
                            Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
                        </label>
                        <div class="flex items-center border-2 border-gray-300 rounded-xl overflow-hidden transition-all duration-300 focus-within:border-blue-500 focus-within:shadow-md">
                            <div class="bg-gray-50 px-4 py-3 font-bold text-gray-700 border-l border-gray-300">
                                <span id="country-code">+972</span>
                            </div>
                            <input type="tel" 
                                   id="phone-number" 
                                   class="flex-1 p-3 outline-none phone-input text-lg font-medium"
                                   placeholder="59XXXXXXX"
                                   maxlength="9"
                                   oninput="formatPhoneNumber(this)">
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <p class="text-sm text-gray-500">
                                <i class="fas fa-info-circle ml-1"></i>
                                ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 5 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 9 Ø£Ø±Ù‚Ø§Ù…
                            </p>
                            <button type="button" 
                                    onclick="fillTestNumber()" 
                                    class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                <i class="fas fa-flask ml-1"></i>
                                Ø±Ù‚Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ
                            </button>
                        </div>
                    </div>

                    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ -->
                    <div class="bg-blue-50 p-4 rounded-xl">
                        <h3 class="font-bold text-blue-800 mb-2 flex items-center">
                            <i class="fas fa-shield-alt ml-2"></i>
                            Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢Ù…Ù†
                        </h3>
                        <p class="text-sm text-blue-700 mb-1">
                            <span class="font-bold">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</span> 
                            <span dir="ltr">Ø±Ù‚Ù…_Ø§Ù„Ù‡Ø§ØªÙ@vip.com</span>
                        </p>
                        <p class="text-sm text-blue-700">
                            <span class="font-bold">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:</span> 
                            <span dir="ltr">Ù…Ø´ÙØ±Ø© Ø¨Ù€ SCRYPT</span>
                        </p>
                    </div>

                    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ù…Ø§Ù† -->
                    <div class="flex flex-wrap gap-2 justify-center">
                        <span class="security-chip">
                            <i class="fas fa-lock text-green-600"></i>
                            ØªØ´ÙÙŠØ± SCRYPT
                        </span>
                        <span class="security-chip">
                            <i class="fas fa-fingerprint text-blue-600"></i>
                            Ø¨ØµÙ…Ø© Ø¬Ù‡Ø§Ø²
                        </span>
                        <span class="security-chip">
                            <i class="fas fa-history text-purple-600"></i>
                            Ø¬Ù„Ø³Ø© ÙˆØ§Ø­Ø¯Ø©
                        </span>
                    </div>
                </div>

                <div class="mt-8">
                    <button type="button" 
                            id="login-btn" 
                            onclick="loginWithPhone()"
                            class="btn-primary w-full text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2">
                        <i class="fas fa-sign-in-alt"></i>
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù…Ù†
                    </button>
                </div>
            </div>

            <!-- Ø§Ù„Ø®Ø·ÙˆØ© 2: Ù†ØªÙŠØ¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
            <div id="step2-content" class="step-content hidden">
                <div class="text-center mb-6">
                    <div id="result-icon" class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <div class="loading"></div>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2" id="result-title">Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...</h2>
                    <p class="text-gray-600" id="result-message">ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ VIP Ø¢Ù…Ù†</p>
                </div>

                <div id="result-content" class="mb-6">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>

                <div class="space-y-3" id="result-actions">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
            </div>
        </div>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ù…Ù†ÙŠØ© -->
        <div class="text-center text-white/90 text-sm space-y-2">
            <p class="flex items-center justify-center gap-2">
                <i class="fas fa-shield-alt"></i>
                <span>Ù†Ø¸Ø§Ù… Ø¢Ù…Ù† - ØªØ´ÙÙŠØ± SCRYPT - Ø¬Ù„Ø³Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ Ø­Ø³Ø§Ø¨</span>
            </p>
            <p class="flex items-center justify-center gap-2">
                <i class="fas fa-ban"></i>
                <span>Ø¨Ø¹Ø¯ 3 Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ù† Ø£Ø¬Ù‡Ø²Ø© Ù…Ø®ØªÙ„ÙØ© ÙŠØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¤Ù‚ØªØ§Ù‹</span>
            </p>
            <p class="flex items-center justify-center gap-2 text-xs opacity-75">
                <i class="fas fa-fingerprint"></i>
                <span id="display-fingerprint"></span>
            </p>
        </div>
    </div>

    <!-- Ø¹Ù†ØµØ± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
    <div id="toast-container" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50"></div>

<script>
    // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù…Ø¹ Hash Config =====
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBWfV0Z1yKxJ-lGJHzi5gStMGTE3CNxmMg",
        authDomain: "aasa-8a079.firebaseapp.com",
        databaseURL: "https://aasa-8a079-default-rtdb.firebaseio.com",
        projectId: "aasa-8a079",
        storageBucket: "aasa-8a079.firebasestorage.app",
        messagingSenderId: "849330713582",
        appId: "1:849330713582:web:7a11b11ebdb5cdcc8b14ff"
    };

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ´ÙÙŠØ± (ØªØ³ØªØ®Ø¯Ù… Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Firebase)
    const HASH_CONFIG = {
        algorithm: "SCRYPT",
        base64_signer_key: "tYFVA7TDWBimqm/4zLK1N6bba4VGjKlQyBmZGRgfGkFLgjmr7eaEy+ZQPSzKImMDn8GSKnGjeYxeeEWlEnSBBA==",
        base64_salt_separator: "Bw==",
        rounds: 8,
        mem_cost: 14
    };

    const TARGET_URL = 'https://mohammad-shehadeh.github.io/price/';
    const SESSION_KEY = 'vip_secure_session';
    const MAX_DEVICE_ATTEMPTS = 3;
    const BLOCK_DURATION = 30 * 60 * 1000; // 30 Ø¯Ù‚ÙŠÙ‚Ø©
    const MAX_FAILED_ATTEMPTS = 5; // 5 Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙØ§Ø´Ù„Ø© Ø®Ù„Ø§Ù„ 15 Ø¯Ù‚ÙŠÙ‚Ø©

    // ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… =====
    const SYSTEM = {
        app: null,
        auth: null,
        database: null,
        isConnected: false,
        currentStep: 1,
        selectedCountry: '972',
        phoneNumber: '',
        currentUser: null,
        currentDeviceId: null,
        deviceFingerprint: null
    };

    // ===== Ø¹Ù†Ø§ØµØ± DOM =====
    const ELEMENTS = {
        systemDot: document.getElementById('system-dot'),
        systemText: document.getElementById('system-text'),
        systemBadge: document.getElementById('system-badge'),
        accountStatus: document.getElementById('account-status'),
        sessionsCount: document.getElementById('sessions-count'),
        deviceFingerprint: document.getElementById('device-fingerprint'),
        displayFingerprint: document.getElementById('display-fingerprint'),
        step1: document.getElementById('step1'),
        step2: document.getElementById('step2'),
        step1Content: document.getElementById('step1-content'),
        step2Content: document.getElementById('step2-content'),
        countryCode: document.getElementById('country-code'),
        phoneNumber: document.getElementById('phone-number'),
        loginBtn: document.getElementById('login-btn'),
        resultIcon: document.getElementById('result-icon'),
        resultTitle: document.getElementById('result-title'),
        resultMessage: document.getElementById('result-message'),
        resultContent: document.getElementById('result-content'),
        resultActions: document.getElementById('result-actions'),
        blockedTemplate: document.getElementById('blocked-template'),
        toastContainer: document.getElementById('toast-container')
    };

    // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© =====
    const SECURITY = {
        // ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
        encrypt: (data) => {
            try {
                const jsonStr = JSON.stringify(data);
                return btoa(encodeURIComponent(jsonStr));
            } catch (e) {
                console.error('Encryption error:', e);
                return null;
            }
        },

        // ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        decrypt: (encrypted) => {
            try {
                const decoded = decodeURIComponent(atob(encrypted));
                return JSON.parse(decoded);
            } catch (e) {
                return null;
            }
        },

        // Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø§Ø´ Ø¢Ù…Ù†
        generateHash: async (text) => {
            const msgBuffer = new TextEncoder().encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        },

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        validateEmail: (email) => {
            const pattern = /^[0-9]{10,13}@vip\.com$/;
            return pattern.test(email);
        },

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ù…Ù†ÙŠØ©
        logSecurityEvent: async (eventType, details) => {
            const db = SYSTEM.database;
            if (!db) return;
            
            try {
                const eventRef = db.ref('security_events').push();
                await eventRef.set({
                    type: eventType,
                    details: details,
                    timestamp: Date.now(),
                    deviceId: SYSTEM.currentDeviceId,
                    fingerprint: SYSTEM.deviceFingerprint,
                    userAgent: navigator.userAgent
                });
            } catch (e) {
                console.error('Failed to log security event:', e);
            }
        }
    };

    // ===== Ù†Ø¸Ø§Ù… ÙƒØ´Ù ÙˆÙ…Ù†Ø¹ Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚ =====
    const INTRUSION_DETECTION = {
        failedAttempts: new Map(),
        
        // ÙƒØ´Ù Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ØªØ®Ù…ÙŠÙ†
        detectBruteForce: async (phoneNumber) => {
            const now = Date.now();
            const attempts = INTRUSION_DETECTION.failedAttempts.get(phoneNumber) || [];
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            const recentAttempts = attempts.filter(t => now - t < 15 * 60 * 1000);
            
            if (recentAttempts.length >= MAX_FAILED_ATTEMPTS) {
                await SECURITY.logSecurityEvent('BRUTE_FORCE_DETECTED', {
                    phoneNumber,
                    attempts: recentAttempts.length,
                    deviceId: SYSTEM.currentDeviceId
                });
                return true;
            }
            
            return false;
        },

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§ÙˆÙ„Ø© ÙØ§Ø´Ù„Ø©
        addFailedAttempt: (phoneNumber) => {
            const attempts = INTRUSION_DETECTION.failedAttempts.get(phoneNumber) || [];
            attempts.push(Date.now());
            INTRUSION_DETECTION.failedAttempts.set(phoneNumber, attempts);
        },

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
        getAdvancedFingerprint: () => {
            const components = [
                navigator.userAgent,
                navigator.language,
                screen.colorDepth,
                screen.width + 'x' + screen.height,
                new Date().getTimezoneOffset(),
                navigator.hardwareConcurrency,
                navigator.deviceMemory || 'unknown',
                navigator.platform,
                navigator.vendor,
                !!navigator.maxTouchPoints,
                !!window.indexedDB,
                !!window.localStorage,
                !!window.sessionStorage,
                Intl.DateTimeFormat().resolvedOptions().timeZone
            ];
            
            return components.join('|');
        }
    };

    // ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª =====
    const SESSION_MANAGER = {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©
        createSession: async (userId, phoneNumber) => {
            const sessionToken = Math.random().toString(36).substring(2) + Date.now().toString(36);
            const fingerprint = INTRUSION_DETECTION.getAdvancedFingerprint();
            const fingerprintHash = await SECURITY.generateHash(fingerprint);
            
            const sessionData = {
                userId,
                phoneNumber,
                sessionToken,
                fingerprintHash,
                createdAt: Date.now(),
                expiresAt: Date.now() + (24 * 60 * 60 * 1000),
                ip: await getClientIP(),
                userAgent: navigator.userAgent,
                deviceId: SYSTEM.currentDeviceId
            };
            
            return sessionData;
        },

        // Ø¥Ù†Ù‡Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
        terminateOtherSessions: async (phoneNumber, currentSessionId) => {
            const db = SYSTEM.database;
            const sessionsRef = db.ref(`active_sessions/${phoneNumber}`);
            const snapshot = await sessionsRef.once('value');
            const sessions = snapshot.val() || {};
            
            let terminatedCount = 0;
            for (const [sessionId, sessionData] of Object.entries(sessions)) {
                if (sessionId !== currentSessionId) {
                    await sessionsRef.child(sessionId).remove();
                    terminatedCount++;
                    
                    // ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©
                    await SECURITY.logSecurityEvent('SESSION_TERMINATED', {
                        phoneNumber,
                        terminatedSession: sessionId,
                        reason: 'new_session_created'
                    });
                }
            }
            
            return terminatedCount;
        }
    };

    // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© =====
    function showToast(message, type = 'info', duration = 3000) {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
            success: 'âœ…',
            error: 'âŒ',
            warning: 'âš ï¸',
            info: 'â„¹ï¸'
        };
        
        toast.innerHTML = `
            <span>${icons[type]}</span>
            <span>${message}</span>
        `;
        
        ELEMENTS.toastContainer.innerHTML = '';
        ELEMENTS.toastContainer.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, duration);
    }

    function updateSystemStatus(status, message, type = 'info') {
        const colors = {
            success: { dot: '#10b981', badge: 'status-connected', text: 'âœ… ' },
            error: { dot: '#ef4444', badge: 'status-disconnected', text: 'âŒ ' },
            warning: { dot: '#f59e0b', badge: 'status-warning', text: 'âš ï¸ ' },
            blocked: { dot: '#dc2626', badge: 'status-blocked', text: 'ğŸš« ' },
            info: { dot: '#3b82f6', badge: '', text: 'ğŸ”µ ' }
        };
        
        const color = colors[type] || colors.info;
        if (ELEMENTS.systemDot) ELEMENTS.systemDot.style.backgroundColor = color.dot;
        if (ELEMENTS.systemText) ELEMENTS.systemText.textContent = message;
        if (ELEMENTS.systemBadge) {
            ELEMENTS.systemBadge.className = `status-badge ${color.badge}`;
            ELEMENTS.systemBadge.innerHTML = `${color.text}${getStatusText(type)}`;
        }
    }

    function getStatusText(type) {
        const texts = {
            success: 'Ø¢Ù…Ù†',
            error: 'ØºÙŠØ± Ù…ØªØµÙ„',
            warning: 'ØªØ­Ø°ÙŠØ±',
            blocked: 'Ù…Ø­Ø¸ÙˆØ±',
            info: 'Ø¬Ø§Ø±ÙŠ'
        };
        return texts[type] || type;
    }

    function goToStep(step) {
        SYSTEM.currentStep = step;
        [ELEMENTS.step1, ELEMENTS.step2].forEach((el, index) => {
            if (el) {
                el.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    el.classList.add('completed');
                    el.innerHTML = '<i class="fas fa-check"></i>';
                } else if (index + 1 === step) {
                    el.classList.add('active');
                    el.innerHTML = `<span>${index + 1}</span>`;
                } else {
                    el.innerHTML = `<span>${index + 1}</span>`;
                }
            }
        });
        
        [ELEMENTS.step1Content, ELEMENTS.step2Content].forEach(el => {
            if (el) el.classList.add('hidden');
        });
        
        if (step === 1 && ELEMENTS.step1Content) ELEMENTS.step1Content.classList.remove('hidden');
        else if (step === 2 && ELEMENTS.step2Content) ELEMENTS.step2Content.classList.remove('hidden');
    }

    // ===== Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¬Ù‡Ø§Ø² =====
    function generateDeviceId() {
        let deviceId = localStorage.getItem('secure_device_id');
        if (!deviceId) {
            const array = new Uint8Array(16);
            crypto.getRandomValues(array);
            deviceId = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            localStorage.setItem('secure_device_id', deviceId);
        }
        return deviceId;
    }

    // ===== Ø¥Ù†Ø´Ø§Ø¡ Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² =====
    async function generateDeviceFingerprint() {
        const fingerprint = INTRUSION_DETECTION.getAdvancedFingerprint();
        const hash = await SECURITY.generateHash(fingerprint);
        
        // Ø¹Ø±Ø¶ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¨ØµÙ…Ø©
        if (ELEMENTS.deviceFingerprint) {
            ELEMENTS.deviceFingerprint.textContent = hash.substring(0, 16) + '...';
        }
        if (ELEMENTS.displayFingerprint) {
            ELEMENTS.displayFingerprint.textContent = 'Ø¨ØµÙ…Ø©: ' + hash.substring(0, 8) + '...';
        }
        
        return hash;
    }

    // ===== Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP =====
    async function getClientIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        } catch {
            return 'unknown_' + Math.random().toString(36).substring(2, 10);
        }
    }

    // ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø± =====
    async function checkAccountBlocked(phoneNumber) {
        const db = SYSTEM.database;
        const blockRef = db.ref(`blocked_accounts/${phoneNumber}`);
        const snapshot = await blockRef.once('value');
        const blockData = snapshot.val();
        
        if (blockData && blockData.blockedUntil > Date.now()) {
            return {
                blocked: true,
                reason: blockData.reason,
                blockedUntil: blockData.blockedUntil,
                attempts: blockData.attempts || []
            };
        } else if (blockData && blockData.blockedUntil <= Date.now()) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø± Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
            await blockRef.remove();
        }
        
        return { blocked: false };
    }

    // ===== ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯Ø®ÙˆÙ„ =====
    async function recordLoginAttempt(phoneNumber, deviceId, ip, success = false) {
        const db = SYSTEM.database;
        const attemptsRef = db.ref(`login_attempts/${phoneNumber}`);
        const snapshot = await attemptsRef.once('value');
        let attempts = snapshot.val() || { 
            devices: {}, 
            count: 0, 
            firstAttempt: Date.now(),
            successfulLogins: 0
        };
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
        if (attempts.firstAttempt < oneDayAgo) {
            attempts = { devices: {}, count: 0, firstAttempt: Date.now(), successfulLogins: 0 };
        }
        
        if (success) {
            attempts.successfulLogins = (attempts.successfulLogins || 0) + 1;
        }
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø²
        if (!attempts.devices[deviceId]) {
            attempts.devices[deviceId] = {
                ip: ip,
                firstSeen: Date.now(),
                lastSeen: Date.now(),
                attempts: 1,
                success: success ? 1 : 0
            };
            attempts.count = (attempts.count || 0) + 1;
        } else {
            attempts.devices[deviceId].lastSeen = Date.now();
            attempts.devices[deviceId].attempts += 1;
            if (success) {
                attempts.devices[deviceId].success = (attempts.devices[deviceId].success || 0) + 1;
            }
        }
        
        await attemptsRef.set(attempts);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯
        if (attempts.count >= MAX_DEVICE_ATTEMPTS) {
            await blockAccount(phoneNumber, 'ØªØ¬Ø§ÙˆØ² Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§');
            return { blocked: true, reason: 'ØªØ¬Ø§ÙˆØ² Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ (3 Ø£Ø¬Ù‡Ø²Ø© Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©)' };
        }
        
        return { blocked: false, attemptsCount: attempts.count };
    }

    // ===== Ø­Ø¸Ø± Ø§Ù„Ø­Ø³Ø§Ø¨ =====
    async function blockAccount(phoneNumber, reason) {
        const db = SYSTEM.database;
        const blockData = {
            reason: reason,
            blockedUntil: Date.now() + BLOCK_DURATION,
            timestamp: Date.now(),
            deviceId: SYSTEM.currentDeviceId
        };
        
        await db.ref(`blocked_accounts/${phoneNumber}`).set(blockData);
        
        // ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ø§Ù„Ø­Ø¸Ø±
        await SECURITY.logSecurityEvent('ACCOUNT_BLOCKED', {
            phoneNumber,
            reason,
            duration: BLOCK_DURATION
        });
        
        updateSystemStatus('blocked', 'Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø­Ø¸ÙˆØ± Ù…Ø¤Ù‚ØªØ§Ù‹', 'blocked');
        showBlockedMessage(reason, BLOCK_DURATION);
        showToast(`ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø­Ø³Ø§Ø¨: ${reason}`, 'error');
    }

    // ===== Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø± =====
    function showBlockedMessage(reason, duration) {
        goToStep(2);
        
        const minutes = Math.ceil(duration / (60 * 1000));
        const endTime = new Date(Date.now() + duration).toLocaleTimeString('ar-SA');
        
        ELEMENTS.resultIcon.innerHTML = '<i class="fas fa-ban text-4xl text-red-600"></i>';
        ELEMENTS.resultTitle.textContent = 'ğŸš« ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø­Ø³Ø§Ø¨';
        ELEMENTS.resultMessage.textContent = 'Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©';
        
        ELEMENTS.resultContent.innerHTML = `
            <div class="blocked-message p-4 rounded-xl">
                <div class="flex items-start gap-3">
                    <i class="fas fa-shield-alt text-red-600 text-xl mt-1"></i>
                    <div>
                        <h3 class="font-bold text-red-800 mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¸Ø± Ø§Ù„Ø£Ù…Ù†ÙŠ</h3>
                        <p class="text-sm text-red-700 mb-2">${reason}</p>
                        <p class="text-xs text-red-600">Ø³ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©</p>
                        <p class="text-xs text-red-600 mt-1">ÙˆÙ‚Øª Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø±: ${endTime}</p>
                        <p class="text-xs text-red-600 mt-2">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¹Ø¯Ù… Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø£Ø¬Ù‡Ø²Ø© Ù…ØªØ¹Ø¯Ø¯Ø©</p>
                    </div>
                </div>
            </div>
        `;
        
        ELEMENTS.resultActions.innerHTML = `
            <button onclick="goToStep(1)" 
                    class="w-full border-2 border-gray-300 text-gray-700 font-bold py-3 px-4 rounded-xl hover:bg-gray-50">
                Ø§Ù„Ø¹ÙˆØ¯Ø©
            </button>
        `;
    }

    // ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© =====
    async function manageActiveSessions(phoneNumber, currentDeviceId) {
        const db = SYSTEM.database;
        const sessionsRef = db.ref(`active_sessions/${phoneNumber}`);
        const snapshot = await sessionsRef.once('value');
        const sessions = snapshot.val() || {};
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø¬Ù„Ø³Ø© ÙØ±ÙŠØ¯
        const sessionId = Math.random().toString(36).substring(2) + Date.now().toString(36);
        
        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
        let terminatedCount = 0;
        for (const [sid, sessionData] of Object.entries(sessions)) {
            if (sessionData.deviceId !== currentDeviceId) {
                await sessionsRef.child(sid).remove();
                terminatedCount++;
            }
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        const fingerprint = await generateDeviceFingerprint();
        await sessionsRef.child(sessionId).set({
            deviceId: currentDeviceId,
            sessionId: sessionId,
            fingerprint: fingerprint,
            loginTime: Date.now(),
            lastActive: Date.now(),
            ip: await getClientIP(),
            userAgent: navigator.userAgent
        });
        
        // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
        const sessionData = {
            phoneNumber,
            deviceId: currentDeviceId,
            sessionId,
            fingerprint,
            loginTime: Date.now()
        };
        
        localStorage.setItem(SESSION_KEY, SECURITY.encrypt(sessionData));
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        updateSessionsCount(1);
        
        if (terminatedCount > 0) {
            showToast(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ${terminatedCount} Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±`, 'warning');
        }
        
        return { success: true, sessionsCount: 1, terminatedCount };
    }

    // ===== ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª =====
    function updateSessionsCount(count) {
        if (ELEMENTS.sessionsCount) {
            ELEMENTS.sessionsCount.textContent = count;
            ELEMENTS.sessionsCount.style.color = count > 1 ? '#dc2626' : '#065f46';
        }
    }

    // ===== ØªÙ‡ÙŠØ¦Ø© Firebase =====
    async function initializeFirebase() {
        try {
            SYSTEM.app = firebase.initializeApp(FIREBASE_CONFIG);
            SYSTEM.auth = firebase.auth();
            SYSTEM.database = firebase.database();
            
            // ØªØ¹ÙŠÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ´ÙÙŠØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            if (SYSTEM.auth.settings) {
                SYSTEM.auth.settings.appVerificationDisabledForTesting = false;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
            const connectedRef = SYSTEM.database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                SYSTEM.isConnected = snap.val() === true;
                if (SYSTEM.isConnected) {
                    updateSystemStatus('success', 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø¢Ù…Ù† ÙˆØ¬Ø§Ù‡Ø²', 'success');
                    showToast('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù…Ù†Ø©', 'success');
                } else {
                    updateSystemStatus('warning', 'ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„', 'warning');
                }
            });
            
            SYSTEM.currentDeviceId = generateDeviceId();
            SYSTEM.deviceFingerprint = await generateDeviceFingerprint();
            
            // ØªØ³Ø¬ÙŠÙ„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
            await SECURITY.logSecurityEvent('SYSTEM_INITIALIZED', {
                deviceId: SYSTEM.currentDeviceId,
                fingerprint: SYSTEM.deviceFingerprint
            });
            
            return true;
            
        } catch (error) {
            console.error('Firebase initialization error:', error);
            updateSystemStatus('error', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
            showToast('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message, 'error');
            return false;
        }
    }

    // ===== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… =====
    function selectCountry(code) {
        SYSTEM.selectedCountry = code;
        if (ELEMENTS.countryCode) ELEMENTS.countryCode.textContent = `+${code}`;
        
        document.querySelectorAll('.country-btn').forEach(btn => {
            btn.classList.remove('active', 'border-blue-500', 'bg-blue-50');
            btn.classList.add('border-gray-300', 'bg-gray-50');
        });
        
        const activeBtn = document.getElementById(`btn-${code}`);
        if (activeBtn) {
            activeBtn.classList.add('active', 'border-blue-500', 'bg-blue-50');
            activeBtn.classList.remove('border-gray-300', 'bg-gray-50');
        }
    }

    function formatPhoneNumber(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 9) value = value.substring(0, 9);
        input.value = value;
        
        const isValid = value.length === 9 && value.startsWith('5');
        input.parentElement.classList.toggle('border-green-500', isValid);
        input.parentElement.classList.toggle('border-red-500', !isValid && value.length > 0);
        if (ELEMENTS.loginBtn) ELEMENTS.loginBtn.disabled = !isValid;
    }

    function fillTestNumber() {
        const testNumbers = ['599123456', '598765432', '597654321'];
        const randomNumber = testNumbers[Math.floor(Math.random() * testNumbers.length)];
        if (ELEMENTS.phoneNumber) {
            ELEMENTS.phoneNumber.value = randomNumber;
            formatPhoneNumber(ELEMENTS.phoneNumber);
        }
    }

    // ===== Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© =====
    async function loginWithPhone() {
        const phone = ELEMENTS.phoneNumber.value.trim();
        
        if (phone.length !== 9 || !phone.startsWith('5')) {
            showToast('âš ï¸ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ù…Ù† 9 Ø£Ø±Ù‚Ø§Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ 5', 'error');
            return;
        }
        
        if (!SYSTEM.isConnected) {
            showToast('âš ï¸ Ø§Ù„Ù†Ø¸Ø§Ù… ØºÙŠØ± Ù…ØªØµÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...', 'warning');
            return;
        }
        
        SYSTEM.phoneNumber = phone;
        const fullPhone = `${SYSTEM.selectedCountry}${phone}`;
        const email = `${fullPhone}@vip.com`;
        const password = phone;
        
        goToStep(2);
        
        ELEMENTS.resultIcon.innerHTML = '<div class="loading"></div>';
        ELEMENTS.resultTitle.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù…Ù†ÙŠ...';
        ELEMENTS.resultMessage.textContent = 'ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØªÙƒ';
        
        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±
            const blockCheck = await checkAccountBlocked(fullPhone);
            if (blockCheck.blocked) {
                const remainingTime = blockCheck.blockedUntil - Date.now();
                showBlockedMessage(blockCheck.reason, remainingTime);
                return;
            }
            
            // ÙƒØ´Ù Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ØªØ®Ù…ÙŠÙ†
            const isBruteForce = await INTRUSION_DETECTION.detectBruteForce(fullPhone);
            if (isBruteForce) {
                await blockAccount(fullPhone, 'Ù†Ø´Ø§Ø· Ù…Ø´Ø¨ÙˆÙ‡ - Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªÙƒØ±Ø±Ø©');
                return;
            }
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            let userCredential;
            let isNewUser = false;
            
            try {
                userCredential = await SYSTEM.auth.signInWithEmailAndPassword(email, password);
                showToast('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (loginError) {
                if (loginError.code === 'auth/user-not-found') {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
                    userCredential = await SYSTEM.auth.createUserWithEmailAndPassword(email, password);
                    isNewUser = true;
                    showToast('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯', 'success');
                } else if (loginError.code === 'auth/wrong-password') {
                    INTRUSION_DETECTION.addFailedAttempt(fullPhone);
                    throw new Error('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                } else {
                    throw loginError;
                }
            }
            
            const user = userCredential.user;
            SYSTEM.currentUser = user;
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP
            const ip = await getClientIP();
            
            // ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø§Ø¬Ø­Ø©
            const attemptResult = await recordLoginAttempt(fullPhone, SYSTEM.currentDeviceId, ip, true);
            
            if (attemptResult.blocked) {
                await blockAccount(fullPhone, attemptResult.reason);
                return;
            }
            
            // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
            const sessionResult = await manageActiveSessions(fullPhone, SYSTEM.currentDeviceId);
            
            // ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ù†Ø§Ø¬Ø­
            await SECURITY.logSecurityEvent('LOGIN_SUCCESS', {
                phoneNumber: fullPhone,
                isNewUser,
                deviceId: SYSTEM.currentDeviceId,
                terminatedSessions: sessionResult.terminatedCount
            });
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            ELEMENTS.resultIcon.innerHTML = '<i class="fas fa-check-circle text-4xl text-green-500"></i>';
            ELEMENTS.resultTitle.textContent = isNewUser ? 'âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨' : 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            ELEMENTS.resultMessage.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù…Ù†...';
            
            ELEMENTS.resultContent.innerHTML = `
                <div class="bg-green-50 p-4 rounded-xl">
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</span>
                            <span dir="ltr" class="font-bold text-green-700">${email}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ù†ÙˆØ¹ Ø§Ù„ØªØ´ÙÙŠØ±:</span>
                            <span class="font-bold text-green-700">SCRYPT (${HASH_CONFIG.rounds} rounds)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø©:</span>
                            <span class="font-bold text-green-700">Ù†Ø´Ø·Ø© (Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¯)</span>
                        </div>
                        ${sessionResult.terminatedCount > 0 ? `
                        <div class="flex justify-between">
                            <span class="text-gray-600">Ø£Ø¬Ù‡Ø²Ø© ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ù‡Ø§:</span>
                            <span class="font-bold text-yellow-600">${sessionResult.terminatedCount}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            ELEMENTS.resultActions.innerHTML = `
                <a href="${TARGET_URL}" target="_blank"
                   class="btn-success w-full text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2">
                    <i class="fas fa-external-link-alt"></i>
                    Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù…Ù†
                </a>
                <button onclick="goToStep(1)" 
                        class="w-full border-2 border-gray-300 text-gray-700 font-bold py-3 px-4 rounded-xl hover:bg-gray-50">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </button>
            `;
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
            if (ELEMENTS.accountStatus) {
                ELEMENTS.accountStatus.textContent = 'âœ… Ù†Ø´Ø· ÙˆØ¢Ù…Ù†';
                ELEMENTS.accountStatus.style.color = '#065f46';
            }
            
        } catch (error) {
            console.error('Login error:', error);
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
            await SECURITY.logSecurityEvent('LOGIN_FAILED', {
                phoneNumber: `${SYSTEM.selectedCountry}${phone}`,
                error: error.message,
                deviceId: SYSTEM.currentDeviceId
            });
            
            ELEMENTS.resultIcon.innerHTML = '<i class="fas fa-exclamation-triangle text-4xl text-yellow-500"></i>';
            ELEMENTS.resultTitle.textContent = 'âš ï¸ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            ELEMENTS.resultMessage.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ù…Ù†ÙŠ';
            
            ELEMENTS.resultContent.innerHTML = `
                <div class="bg-yellow-50 p-4 rounded-xl">
                    <p class="text-yellow-700 text-center">${error.message}</p>
                    <p class="text-xs text-yellow-600 text-center mt-2">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø£Ù…Ø§Ù†</p>
                </div>
            `;
            
            ELEMENTS.resultActions.innerHTML = `
                <button onclick="goToStep(1)" 
                        class="btn-primary w-full text-white font-bold py-3 px-4 rounded-xl">
                    <i class="fas fa-redo ml-2"></i>
                    Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                </button>
            `;
        }
    }

    // ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© =====
    async function checkCurrentSession() {
        const savedSession = localStorage.getItem(SESSION_KEY);
        if (savedSession) {
            try {
                const session = SECURITY.decrypt(savedSession);
                if (session && session.deviceId === SYSTEM.currentDeviceId) {
                    const timeSinceLogin = Date.now() - session.loginTime;
                    
                    if (timeSinceLogin < 24 * 60 * 60 * 1000) { // Ø£Ù‚Ù„ Ù…Ù† 24 Ø³Ø§Ø¹Ø©
                        updateSystemStatus('success', 'Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø©', 'success');
                        if (ELEMENTS.accountStatus) {
                            ELEMENTS.accountStatus.textContent = 'âœ… Ù†Ø´Ø·';
                            ELEMENTS.accountStatus.style.color = '#065f46';
                        }
                        updateSessionsCount(1);
                        showToast('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©', 'info');
                        return true;
                    }
                }
            } catch (e) {
                console.log('Invalid session');
                localStorage.removeItem(SESSION_KEY);
            }
        }
        return false;
    }

    // ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… =====
    async function initializeSystem() {
        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø§ØªØµØ§Ù„
        window.addEventListener('online', () => {
            updateSystemStatus('success', 'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„', 'success');
            showToast('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'success');
        });
        
        window.addEventListener('offline', () => {
            updateSystemStatus('error', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„', 'error');
            showToast('Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error');
        });
        
        selectCountry('972');
        goToStep(1);
        
        const firebaseReady = await initializeFirebase();
        if (firebaseReady) {
            await checkCurrentSession();
        }
        
        console.log('ğŸš€ Ù†Ø¸Ø§Ù… VIP Ø§Ù„Ø¢Ù…Ù† Ø¬Ø§Ù‡Ø² Ù…Ø¹ ØªØ´ÙÙŠØ± SCRYPT');
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    document.addEventListener('DOMContentLoaded', initializeSystem);
</script>
</body>
</html>