<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù„ÙŠ - Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            font-family: 'Segoe UI', 'Tahoma', 'Geneva', 'Verdana', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(to right, #3b82f6, #2563eb);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(to right, #10b981, #059669);
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
        }
        
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .step-indicator {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }
        
        .step-indicator.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
            transform: scale(1.1);
        }
        
        .step-indicator.completed {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-connected {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .status-disconnected {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .status-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .phone-input {
            direction: ltr;
            text-align: center;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
        
        .success-check {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(to right, #10b981, #34d399);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        
        .countdown-number {
            font-family: monospace;
            font-size: 2rem;
            font-weight: bold;
            color: #3b82f6;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4 min-h-screen">
    <div class="w-full max-w-md mx-auto">
        <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… -->
        <div class="text-center mb-8 slide-in">
            <div class="inline-block p-4 bg-white/20 backdrop-blur-sm rounded-2xl mb-4">
                <i class="fas fa-shield-alt text-white text-4xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù…Ù†</h1>
            <p class="text-blue-100 opacity-90">Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø¢Ù„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</p>
        </div>

        <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div class="card rounded-2xl shadow-2xl p-6 mb-6 slide-in" style="animation-delay: 0.1s;">
            <!-- Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… -->
            <div class="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-gray-300" id="system-dot"></div>
                        <span class="text-sm font-medium text-gray-700" id="system-text">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...</span>
                    </div>
                    <div id="system-badge" class="status-badge">...</div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 text-xs">
                    <div class="flex items-center justify-between p-2 bg-white rounded-lg">
                        <span class="text-gray-600">Firebase</span>
                        <span id="firebase-status" class="font-medium">...</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-white rounded-lg">
                        <span class="text-gray-600">Ø§Ù„Ø§ØªØµØ§Ù„</span>
                        <span id="network-status" class="font-medium">...</span>
                    </div>
                </div>
            </div>

            <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù… -->
            <div class="flex items-center justify-center mb-8">
                <div class="flex items-center">
                    <div class="step-indicator active" id="step1">
                        <span>1</span>
                    </div>
                    <div class="w-20 h-1 bg-gray-300 mx-2"></div>
                    <div class="step-indicator" id="step2">
                        <span>2</span>
                    </div>
                    <div class="w-20 h-1 bg-gray-300 mx-2"></div>
                    <div class="step-indicator" id="step3">
                        <span>3</span>
                    </div>
                </div>
            </div>

            <!-- Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… -->
            <div id="step1-content" class="step-content fade-in">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-phone-alt text-blue-600 text-2xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ</h2>
                    <p class="text-gray-600">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯Ù‡ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                </div>

                <div class="space-y-4">
                    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© -->
                    <div>
                        <label class="block text-gray-700 mb-2 font-medium">
                            <i class="fas fa-globe-asia text-blue-500 mr-2"></i>
                            Ø§Ø®ØªØ± Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©
                        </label>
                        <div class="grid grid-cols-2 gap-3">
                            <button type="button" id="btn-972" 
                                    class="country-btn active" 
                                    onclick="selectCountry('972')">
                                <span class="text-lg">ğŸ‡µğŸ‡¸</span>
                                <span class="font-bold">+972</span>
                                <span class="text-xs text-gray-600">ÙÙ„Ø³Ø·ÙŠÙ†</span>
                            </button>
                            <button type="button" id="btn-970" 
                                    class="country-btn" 
                                    onclick="selectCountry('970')">
                                <span class="text-lg">ğŸ‡µğŸ‡¸</span>
                                <span class="font-bold">+970</span>
                                <span class="text-xs text-gray-600">ÙÙ„Ø³Ø·ÙŠÙ†</span>
                            </button>
                        </div>
                    </div>

                    <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… -->
                    <div>
                        <label class="block text-gray-700 mb-2 font-medium">
                            <i class="fas fa-mobile-alt text-blue-500 mr-2"></i>
                            Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
                        </label>
                        <div class="flex items-center border-2 border-gray-300 rounded-xl overflow-hidden transition-all duration-300 focus-within:border-blue-500 focus-within:shadow-md">
                            <div class="bg-gray-50 px-4 py-3 font-bold text-gray-700 border-r border-gray-300">
                                <span id="country-code">+972</span>
                            </div>
                            <input type="tel" 
                                   id="phone-number" 
                                   class="flex-1 p-3 outline-none phone-input text-lg font-medium"
                                   placeholder="59XXXXXXX"
                                   maxlength="9"
                                   oninput="formatPhoneNumber(this)">
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <p class="text-sm text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i>
                                ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 5 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 9 Ø£Ø±Ù‚Ø§Ù…
                            </p>
                            <button type="button" 
                                    onclick="fillTestNumber()" 
                                    class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                <i class="fas fa-vial mr-1"></i>
                                Ø±Ù‚Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-8 space-y-3">
                    <button type="button" 
                            id="verify-btn" 
                            onclick="verifyPhoneNumber()"
                            class="btn-primary w-full text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2">
                        <i class="fas fa-search"></i>
                        Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù…
                    </button>
                    
                    <button type="button" 
                            onclick="skipToTarget()" 
                            class="w-full border-2 border-gray-300 text-gray-700 font-bold py-3 px-4 rounded-xl hover:bg-gray-50 transition-colors">
                        <i class="fas fa-external-link-alt mr-2"></i>
                        Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
                    </button>
                </div>
            </div>

            <!-- Ø§Ù„Ø®Ø·ÙˆØ© 2: Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù‚Ù‚ -->
            <div id="step2-content" class="step-content hidden">
                <div class="text-center mb-6">
                    <div id="result-icon" class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <div class="loading"></div>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2" id="result-title">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</h2>
                    <p class="text-gray-600" id="result-message">ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                </div>

                <div id="result-content" class="mb-6">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>

                <div class="space-y-3" id="result-actions">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
            </div>

            <!-- Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù„ÙŠ -->
            <div id="step3-content" class="step-content hidden">
                <div class="text-center py-4">
                    <div class="loading mx-auto mb-6" style="width: 40px; height: 40px;"></div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2 pulse-animation" id="auto-login-title">Ø¬Ø§Ø±ÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù„ÙŠ...</h2>
                    <p class="text-gray-600 mb-6" id="auto-login-message">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªÙƒØªÙ…Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</p>
                    
                    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© -->
                    <div class="bg-gray-50 rounded-xl p-4 mb-6 text-left">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-user-circle text-blue-500 mr-2"></i>
                            Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</span>
                                <span id="session-phone" class="font-bold">+972 5XXXXXXXX</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚:</span>
                                <span id="session-status" class="font-medium">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span>
                                <code class="font-mono bg-gray-100 px-2 py-1 rounded">382659</code>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù:</span>
                                <a href="https://mohammad-shehadeh.github.io/price/" 
                                   target="_blank"
                                   class="text-blue-600 hover:text-blue-800 flex items-center">
                                    mohammad-shehadeh.github.io
                                    <i class="fas fa-external-link-alt mr-1 text-xs"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ -->
                    <div id="countdown-container" class="hidden">
                        <div class="flex items-center justify-center gap-2 mb-4">
                            <span class="text-gray-700">Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø®Ù„Ø§Ù„</span>
                            <div class="countdown-number" id="countdown-display">5</div>
                            <span class="text-gray-700">Ø«ÙˆØ§Ù†ÙŠ</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-6">
                            <div id="countdown-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Ø²Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ÙŠØ¯ÙˆÙŠ -->
                    <a href="https://mohammad-shehadeh.github.io/price/" 
                       target="_blank"
                       id="manual-redirect"
                       class="btn-success w-full text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 hover:shadow-lg">
                        <i class="fas fa-paper-plane"></i>
                        Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø¢Ù†
                    </a>
                </div>
            </div>
        </div>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
        <div class="text-center text-white/90 text-sm space-y-2">
            <p class="flex items-center justify-center gap-2">
                <i class="fas fa-shield-alt"></i>
                <span>Ù†Ø¸Ø§Ù… Ø¢Ù…Ù† Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ù€ Firebase</span>
            </p>
            <p class="flex items-center justify-center gap-2">
                <i class="fas fa-bolt"></i>
                <span>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù„ÙŠ Ø¨Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø«Ø§Ø¨Øª: 382659</span>
            </p>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ -->
    <div id="emergency-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6">
            <div class="text-center mb-4">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">ÙˆØ¶Ø¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h3>
                <p class="text-gray-600 mb-4">Firebase ØºÙŠØ± Ù…ØªØµÙ„. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±.</p>
            </div>
            
            <div class="space-y-3">
                <button type="button" 
                        onclick="enableEmergencyMode()"
                        class="w-full bg-yellow-100 text-yellow-800 font-bold py-3 px-4 rounded-xl hover:bg-yellow-200 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-play-circle"></i>
                    ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                </button>
                
                <button type="button" 
                        onclick="retryFirebaseConnection()"
                        class="w-full border-2 border-gray-300 text-gray-700 font-bold py-3 px-4 rounded-xl hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-redo"></i>
                    Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                </button>
                
                <button type="button" 
                        onclick="closeEmergencyModal()"
                        class="w-full text-gray-600 font-medium py-2 px-4 rounded-xl hover:text-gray-800">
                    Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </div>
    </div>

<script>
    // ===== Ù…ÙØªØ§Ø­ Ø§Ù„Ø¬Ù„Ø³Ø© =====
    const SESSION_KEY = 'shehadeh_login_session';
    const TARGET_URL = 'https://mohammad-shehadeh.github.io/price/index.html';

    // ===== ØªÙ‡ÙŠØ¦Ø© Firebase =====
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBWfV0Z1yKxJ-lGJHzi5gStMGTE3CNxmMg",
        authDomain: "aasa-8a079.firebaseapp.com",
        databaseURL: "https://aasa-8a079-default-rtdb.firebaseio.com",
        projectId: "aasa-8a079",
        storageBucket: "aasa-8a079.firebasestorage.app",
        messagingSenderId: "849330713582",
        appId: "1:849330713582:web:7a11b11ebdb5cdcc8b14ff",
        measurementId: "G-LY2WSQ21GE"
    };

    // ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… =====
    const SYSTEM = {
        app: null,
        auth: null,
        database: null,
        recaptcha: null,
        isConnected: false,
        isEmergencyMode: false,
        currentStep: 1,
        selectedCountry: '972',
        phoneNumber: '',
        userExists: false,
        retryCount: 0,
        MAX_RETRIES: 3
    };

    // ===== Ø¹Ù†Ø§ØµØ± DOM =====
    const ELEMENTS = {
        systemDot: document.getElementById('system-dot'),
        systemText: document.getElementById('system-text'),
        systemBadge: document.getElementById('system-badge'),
        firebaseStatus: document.getElementById('firebase-status'),
        networkStatus: document.getElementById('network-status'),
        step1: document.getElementById('step1'),
        step2: document.getElementById('step2'),
        step3: document.getElementById('step3'),
        step1Content: document.getElementById('step1-content'),
        step2Content: document.getElementById('step2-content'),
        step3Content: document.getElementById('step3-content'),
        countryCode: document.getElementById('country-code'),
        phoneNumber: document.getElementById('phone-number'),
        verifyBtn: document.getElementById('verify-btn'),
        resultIcon: document.getElementById('result-icon'),
        resultTitle: document.getElementById('result-title'),
        resultMessage: document.getElementById('result-message'),
        resultContent: document.getElementById('result-content'),
        resultActions: document.getElementById('result-actions'),
        autoLoginTitle: document.getElementById('auto-login-title'),
        autoLoginMessage: document.getElementById('auto-login-message'),
        sessionPhone: document.getElementById('session-phone'),
        sessionStatus: document.getElementById('session-status'),
        countdownContainer: document.getElementById('countdown-container'),
        countdownDisplay: document.getElementById('countdown-display'),
        countdownProgress: document.getElementById('countdown-progress'),
        manualRedirect: document.getElementById('manual-redirect'),
        emergencyModal: document.getElementById('emergency-modal')
    };

    // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù…Ø®ØªØµØ±Ø©) =====
    function updateSystemStatus(status, message, type = 'info') {
        const colors = {
            success: { dot: '#10b981', badge: 'status-connected', text: 'âœ… ' },
            error: { dot: '#ef4444', badge: 'status-disconnected', text: 'âŒ ' },
            warning: { dot: '#f59e0b', badge: 'status-warning', text: 'âš ï¸ ' },
            info: { dot: '#3b82f6', badge: '', text: 'â„¹ï¸ ' }
        };
        
        const color = colors[type];
        if (ELEMENTS.systemDot) ELEMENTS.systemDot.style.backgroundColor = color.dot;
        if (ELEMENTS.systemText) ELEMENTS.systemText.textContent = message;
        if (ELEMENTS.systemBadge) {
            ELEMENTS.systemBadge.className = `status-badge ${color.badge}`;
            ELEMENTS.systemBadge.innerHTML = `${color.text}${type === 'success' ? 'Ù…ØªØµÙ„' : type === 'error' ? 'ØºÙŠØ± Ù…ØªØµÙ„' : 'ØªØ­Ø°ÙŠØ±'}`;
        }
        if (ELEMENTS.firebaseStatus) {
            ELEMENTS.firebaseStatus.textContent = SYSTEM.isConnected ? 'âœ… Ù…ØªØµÙ„' : 'âŒ ØºÙŠØ± Ù…ØªØµÙ„';
            ELEMENTS.firebaseStatus.style.color = SYSTEM.isConnected ? '#065f46' : '#991b1b';
        }
    }

    function updateNetworkStatus() {
        const isOnline = navigator.onLine;
        if (ELEMENTS.networkStatus) {
            ELEMENTS.networkStatus.textContent = isOnline ? 'âœ… Ù…ØªØµÙ„' : 'âŒ ØºÙŠØ± Ù…ØªØµÙ„';
            ELEMENTS.networkStatus.style.color = isOnline ? '#065f46' : '#991b1b';
        }
        return isOnline;
    }

    function goToStep(step) {
        SYSTEM.currentStep = step;
        [ELEMENTS.step1, ELEMENTS.step2, ELEMENTS.step3].forEach((el, index) => {
            if (el) {
                el.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    el.classList.add('completed');
                    el.innerHTML = '<i class="fas fa-check"></i>';
                } else if (index + 1 === step) {
                    el.classList.add('active');
                }
            }
        });
        
        [ELEMENTS.step1Content, ELEMENTS.step2Content, ELEMENTS.step3Content].forEach(el => {
            if (el) el.classList.add('hidden');
        });
        
        if (step === 1 && ELEMENTS.step1Content) ELEMENTS.step1Content.classList.remove('hidden');
        else if (step === 2 && ELEMENTS.step2Content) ELEMENTS.step2Content.classList.remove('hidden');
        else if (step === 3 && ELEMENTS.step3Content) ELEMENTS.step3Content.classList.remove('hidden');
    }

    // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¬Ù„Ø³Ø© =====
    function saveUserSession(phoneNumber, countryCode) {
        const sessionData = {
            phoneNumber: phoneNumber,
            countryCode: countryCode,
            loginTime: new Date().toISOString(),
            timestamp: Date.now()
        };
        localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', phoneNumber);
    }

    // ===== Ø¥Ø¯Ø§Ø±Ø© Firebase =====
    async function initializeFirebase() {
        try {
            updateSystemStatus('info', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase...');
            
            if (!updateNetworkStatus()) {
                throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
            }
            
            SYSTEM.app = firebase.initializeApp(FIREBASE_CONFIG);
            SYSTEM.auth = firebase.auth();
            SYSTEM.database = firebase.database();
            
            const testRef = SYSTEM.database.ref('.info/connected');
            testRef.on('value', (snapshot) => {
                SYSTEM.isConnected = snapshot.val() === true;
                if (SYSTEM.isConnected) {
                    updateSystemStatus('success', 'Firebase Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø²');
                    SYSTEM.retryCount = 0;
                } else {
                    updateSystemStatus('warning', 'ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase');
                }
            });
            
            await SYSTEM.auth.signInAnonymously();
            
            SYSTEM.isConnected = true;
            updateSystemStatus('success', 'Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');
            return true;
            
        } catch (error) {
            console.error('âŒ Firebase initialization failed:', error);
            SYSTEM.isConnected = false;
            SYSTEM.retryCount++;
            
            if (SYSTEM.retryCount <= SYSTEM.MAX_RETRIES) {
                updateSystemStatus('warning', `Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (${SYSTEM.retryCount}/${SYSTEM.MAX_RETRIES})...`);
                setTimeout(() => initializeFirebase(), 2000 * SYSTEM.retryCount);
            } else {
                updateSystemStatus('error', 'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase');
                showEmergencyModal();
            }
            return false;
        }
    }

    function retryFirebaseConnection() {
        closeEmergencyModal();
        SYSTEM.retryCount = 0;
        initializeFirebase();
    }

    function enableEmergencyMode() {
        SYSTEM.isEmergencyMode = true;
        SYSTEM.isConnected = false;
        closeEmergencyModal();
        updateSystemStatus('warning', 'ÙˆØ¶Ø¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ù…ÙØ¹Ù„ - Ø¨Ø¯ÙˆÙ† Firebase');
        alert('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ø®ØªØ¨Ø§Ø±ÙŠ.');
    }

    function closeEmergencyModal() {
        if (ELEMENTS.emergencyModal) ELEMENTS.emergencyModal.classList.add('hidden');
    }

    function showEmergencyModal() {
        if (ELEMENTS.emergencyModal) ELEMENTS.emergencyModal.classList.remove('hidden');
    }

    // ===== Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… =====
    function selectCountry(code) {
        SYSTEM.selectedCountry = code;
        if (ELEMENTS.countryCode) ELEMENTS.countryCode.textContent = `+${code}`;
        
        document.querySelectorAll('.country-btn').forEach(btn => {
            btn.classList.remove('active', 'border-blue-500', 'bg-blue-50');
            btn.classList.add('border-gray-300', 'bg-gray-50');
        });
        
        const activeBtn = document.getElementById(`btn-${code}`);
        if (activeBtn) {
            activeBtn.classList.add('active', 'border-blue-500', 'bg-blue-50');
            activeBtn.classList.remove('border-gray-300', 'bg-gray-50');
        }
    }

    function formatPhoneNumber(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 9) value = value.substring(0, 9);
        input.value = value;
        
        if (value.length === 9 && value.startsWith('5')) {
            input.parentElement.classList.add('border-green-500');
            input.parentElement.classList.remove('border-red-500');
            if (ELEMENTS.verifyBtn) ELEMENTS.verifyBtn.disabled = false;
        } else {
            input.parentElement.classList.add('border-red-500');
            input.parentElement.classList.remove('border-green-500');
            if (ELEMENTS.verifyBtn) ELEMENTS.verifyBtn.disabled = true;
        }
    }

    function fillTestNumber() {
        const testNumbers = ['599123456', '598765432', '597654321'];
        const randomNumber = testNumbers[Math.floor(Math.random() * testNumbers.length)];
        if (ELEMENTS.phoneNumber) {
            ELEMENTS.phoneNumber.value = randomNumber;
            formatPhoneNumber(ELEMENTS.phoneNumber);
        }
    }

    // ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =====
    async function verifyPhoneNumber() {
        const phone = ELEMENTS.phoneNumber.value.trim();
        
        if (phone.length !== 9 || !phone.startsWith('5')) {
            alert('âš ï¸ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ù…Ù† 9 Ø£Ø±Ù‚Ø§Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ 5');
            return;
        }
        
        SYSTEM.phoneNumber = phone;
        const fullPhone = `+${SYSTEM.selectedCountry}${phone}`;
        
        goToStep(2);
        
        ELEMENTS.resultIcon.innerHTML = '<div class="loading"></div>';
        ELEMENTS.resultTitle.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
        ELEMENTS.resultMessage.textContent = 'ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…';
        
        ELEMENTS.resultContent.innerHTML = `
            <div class="text-center py-4">
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-700">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ø®Ù„:</span>
                        <span class="font-bold text-lg">${fullPhone}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-700">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚:</span>
                        <span class="font-medium">${SYSTEM.isConnected ? 'Firebase' : 'ÙˆØ¶Ø¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦'}</span>
                    </div>
                </div>
            </div>
        `;
        
        try {
            let userExists = false;
            let verificationMethod = '';
            
            if (SYSTEM.isConnected && !SYSTEM.isEmergencyMode) {
                verificationMethod = 'Firebase';
                
                try {
                    if (!SYSTEM.recaptcha) {
                        SYSTEM.recaptcha = new firebase.auth.RecaptchaVerifier('verify-btn', {
                            size: 'invisible'
                        });
                    }
                    
                    await SYSTEM.auth.signInWithPhoneNumber(fullPhone, SYSTEM.recaptcha);
                    userExists = true;
                    
                } catch (firebaseError) {
                    console.log('Firebase verification error:', firebaseError);
                    if (firebaseError.code === 'auth/invalid-phone-number') {
                        userExists = false;
                    } else if (firebaseError.code === 'auth/too-many-requests') {
                        userExists = true;
                    } else {
                        userExists = false;
                    }
                }
            } else {
                verificationMethod = 'ÙˆØ¶Ø¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦';
                userExists = true;
            }
            
            SYSTEM.userExists = userExists;
            
            if (userExists) {
                // âœ… Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ­Ù‚Ù‚ - Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ index.html
                saveUserSession(fullPhone, SYSTEM.selectedCountry);
                
                ELEMENTS.resultIcon.innerHTML = '<i class="fas fa-check-circle text-3xl text-green-500"></i>';
                ELEMENTS.resultTitle.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­';
                ELEMENTS.resultMessage.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹...';
                
                ELEMENTS.resultContent.innerHTML = `
                    <div class="p-4 bg-green-50 border border-green-200 rounded-xl">
                        <div class="text-center">
                            <div class="loading mx-auto mb-3"></div>
                            <p class="text-green-700 mb-2">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­</p>
                            <p class="text-sm text-gray-600">Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø®Ù„Ø§Ù„ 3 Ø«ÙˆØ§Ù†ÙŠ</p>
                        </div>
                    </div>
                `;
                
                ELEMENTS.resultActions.innerHTML = '';
                
                // ØªØ£Ø®ÙŠØ± 3 Ø«ÙˆØ§Ù†ÙŠ Ø«Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„
                setTimeout(() => {
                    window.location.href = TARGET_URL;
                }, 3000);
                
            } else {
                showVerificationResult(false, fullPhone, verificationMethod);
            }
            
        } catch (error) {
            console.error('Verification failed:', error);
            showErrorResult(error.message);
        }
    }

    function showVerificationResult(exists, fullPhone, method) {
        ELEMENTS.resultIcon.innerHTML = '<i class="fas fa-times-circle text-3xl text-red-500"></i>';
        ELEMENTS.resultTitle.textContent = 'âŒ Ø§Ù„ØªØ­Ù‚Ù‚ ÙØ´Ù„';
        ELEMENTS.resultMessage.textContent = 'Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…';
        
        ELEMENTS.resultContent.innerHTML = `
            <div class="p-4 bg-red-50 border border-red-200 rounded-xl">
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">Ø§Ù„Ø±Ù‚Ù…:</span>
                        <span class="font-bold">${fullPhone}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">Ø³Ø¨Ø¨ Ø§Ù„ÙØ´Ù„:</span>
                        <span class="text-red-600 font-medium">ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ ${method}</span>
                    </div>
                </div>
            </div>
        `;
        
        ELEMENTS.resultActions.innerHTML = `
            <button onclick="goToStep(1)" 
                    class="btn-primary w-full text-white font-bold py-3 px-4 rounded-xl">
                <i class="fas fa-redo mr-2"></i>
                ØªØ¬Ø±Ø¨Ø© Ø±Ù‚Ù… Ø¢Ø®Ø±
            </button>
            ${!SYSTEM.isEmergencyMode ? `
            <button onclick="enableEmergencyModeAndRetry()" 
                    class="w-full border-2 border-yellow-300 text-yellow-700 font-bold py-3 px-4 rounded-xl hover:bg-yellow-50">
                <i class="fas fa-bolt mr-2"></i>
                Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ¶Ø¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
            </button>
            ` : ''}
        `;
    }

    function enableEmergencyModeAndRetry() {
        enableEmergencyMode();
        verifyPhoneNumber();
    }

    function showErrorResult(errorMessage) {
        ELEMENTS.resultIcon.innerHTML = '<i class="fas fa-exclamation-triangle text-3xl text-yellow-500"></i>';
        ELEMENTS.resultTitle.textContent = 'âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚';
        ELEMENTS.resultMessage.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚';
        
        ELEMENTS.resultContent.innerHTML = `
            <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-xl">
                <p class="text-yellow-700 text-center">${errorMessage}</p>
            </div>
        `;
        
        ELEMENTS.resultActions.innerHTML = `
            <button onclick="verifyPhoneNumber()" 
                    class="btn-primary w-full text-white font-bold py-3 px-4 rounded-xl">
                <i class="fas fa-redo mr-2"></i>
                Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            </button>
            <button onclick="goToStep(1)" 
                    class="w-full border-2 border-gray-300 text-gray-700 font-bold py-3 px-4 rounded-xl hover:bg-gray-50">
                Ø§Ù„Ø¹ÙˆØ¯Ø©
            </button>
        `;
    }

    // ===== ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© =====
    function startAutoLogin() {}
    function performAutoLoginProcess() {}
    function saveSessionData() {}
    function startCountdown() {}
    function redirectToTarget() {}
    function checkExistingSession() { return false; }
    function skipToTarget() {}

    // ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… =====
    async function initializeSystem() {
        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);
        
        selectCountry('972');
        goToStep(1);
        
        await initializeFirebase();
        
        console.log('ğŸš€ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¬Ø§Ù‡Ø²Ø©');
    }

    // ===== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ =====
    document.addEventListener('DOMContentLoaded', initializeSystem);
</script>
</body>
</html>