<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نظام إدارة المنتجات</title>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #27ae60;
    }
    body {
      font-family: 'Arial Arabic', Tahoma;
      margin: 0;
      padding: 20px;
      background: #f5f6fa;
    }
    .nav-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    .nav-btn {
      padding: 12px 25px;
      border-radius: 25px;
      background: var(--secondary-color);
      color: white;
      border: none;
      cursor: pointer;
    }
    .page {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .search-filter {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .search-input {
      flex: 1;
      padding: 8px;
      border-radius: 25px;
      border: 1px solid #ddd;
      min-width: 250px;
    }
    .filter-select {
      padding: 8px;
      border-radius: 25px;
      border: 1px solid #ddd;
      background: white;
    }
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .product-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      transition: transform 0.2s;
    }
    .product-card:hover {
      transform: scale(1.02);
    }
    .product-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 5px;
    }
    .barcode-list {
      margin-top: 10px;
    }
    .barcode-item {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      padding: 5px;
      background: #f0f0f0;
      border-radius: 5px;
      font-size: 14px;
    }
    /* نمط المودال لإدارة الباركودات */
    #barcodeModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      z-index: 1000;
      width: 300px;
    }
    #modalOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 900;
    }
    button {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="nav-bar">
    <button class="nav-btn" onclick="showPage('products')">إدارة المنتجات</button>
  </div>

  <!-- صفحة إدارة المنتجات -->
  <div id="products" class="page">
    <div class="search-filter">
      <input type="text" class="search-input" id="searchInput" placeholder="بحث بالاسم أو الباركود...">
      <select class="filter-select" id="categoryFilter" onchange="filterProducts()">
        <option value="">جميع الفئات</option>
      </select>
    </div>
    <div class="products-grid" id="productsContainer"></div>
  </div>

  <!-- مودال إدارة الباركودات -->
  <div id="modalOverlay" onclick="closeModal()"></div>
  <div id="barcodeModal">
    <h3>إدارة الباركودات</h3>
    <div id="barcodeList"></div>
    <input type="text" id="newBarcode" placeholder="إضافة باركود جديد">
    <button onclick="addBarcode()">➕ إضافة</button>
    <button onclick="closeModal()">إغلاق</button>
  </div>

  <script>
    let products = [];
    let categories = new Set();
    let currentProduct = null;

    // إظهار الصفحة المطلوبة
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
      document.getElementById(pageId).style.display = 'block';
    }

    // جلب المنتجات من الملف المحلي وتخزين عدة باركودات لكل صنف
    async function fetchProducts() {
      try {
        const response = await fetch('test.txt');
        if (!response.ok) throw new Error('فشل في جلب الملف');
        
        const data = await response.text();
        products = data.split('\n')
          .filter(line => line.trim() !== '')
          .map(line => {
            const [category, name, price, image] = line.split('/').map(item => item.trim());
            if (!category || !name || isNaN(price) || !image) {
              console.error('بيانات غير صالحة في السطر:', line);
              return null;
            }
            categories.add(category);
            return {
              category,
              name,
              price: parseFloat(price),
              image,
              // تخزين الباركودات كمصفوفة من القيم
              barcodes: JSON.parse(localStorage.getItem(name) || '[]')
            };
          })
          .filter(product => product !== null);

        updateCategoryFilter();
        renderProducts();
      } catch (error) {
        console.error('حدث خطأ في جلب البيانات:', error);
        alert('خطأ في تحميل البيانات! تأكد من وجود ملف test.txt وبنيته صحيحة.');
      }
    }

    // تحديث قائمة الفئات بناءً على المنتجات
    function updateCategoryFilter() {
      const filter = document.getElementById('categoryFilter');
      filter.innerHTML = `<option value="">جميع الفئات</option>` +
        Array.from(categories).map(cat => `<option value="${cat}">${cat}</option>`).join('');
    }

    // تصفية المنتجات حسب البحث والفئة المحددة
    function filterProducts() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const selectedCategory = document.getElementById('categoryFilter').value;
      const filtered = products.filter(product => {
        const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                              product.barcodes.some(b => b.toLowerCase().includes(searchTerm));
        const matchesCategory = !selectedCategory || product.category === selectedCategory;
        return matchesSearch && matchesCategory;
      });
      renderProducts(filtered);
    }

    // عرض المنتجات في صفحة إدارة المنتجات
    function renderProducts(productsToShow = products) {
      const container = document.getElementById('productsContainer');
      container.innerHTML = productsToShow.map(product => `
        <div class="product-card">
          <img src="${product.image}" alt="${product.name}">
          <h3>${product.name}</h3>
          <p>الفئة: ${product.category}</p>
          <p>السعر: ${product.price.toFixed(2)} ₪</p>
          <div class="barcode-list">
            ${product.barcodes.length > 0 ? product.barcodes.map(b => `<div class="barcode-item">${b}</div>`).join('') : '<em>لا يوجد باركود</em>'}
          </div>
          <button onclick="showBarcodeManager('${product.name}')">إدارة الباركودات</button>
        </div>
      `).join('');
    }

    // إدارة الباركودات: عرض المودال وإدراج الباركودات الحالية
    function showBarcodeManager(productName) {
      currentProduct = products.find(p => p.name === productName);
      if(!currentProduct) return;
      document.getElementById('barcodeList').innerHTML = currentProduct.barcodes.map(barcode => `
        <div class="barcode-item">
          <span>${barcode}</span>
          <button onclick="removeBarcode('${barcode}')">🗑️</button>
        </div>
      `).join('');
      document.getElementById('newBarcode').value = '';
      document.getElementById('modalOverlay').style.display = 'block';
      document.getElementById('barcodeModal').style.display = 'block';
    }

    // إضافة باركود جديد للصنف الحالي
    function addBarcode() {
      const newBarcode = document.getElementById('newBarcode').value.trim();
      if (!newBarcode) return;
      if (!currentProduct.barcodes.includes(newBarcode)) {
        currentProduct.barcodes.push(newBarcode);
        localStorage.setItem(currentProduct.name, JSON.stringify(currentProduct.barcodes));
        showBarcodeManager(currentProduct.name);
      }
      document.getElementById('newBarcode').value = '';
    }

    // إزالة باركود من الصنف الحالي
    function removeBarcode(barcode) {
      currentProduct.barcodes = currentProduct.barcodes.filter(b => b !== barcode);
      localStorage.setItem(currentProduct.name, JSON.stringify(currentProduct.barcodes));
      showBarcodeManager(currentProduct.name);
    }

    // إغلاق المودال
    function closeModal() {
      document.getElementById('barcodeModal').style.display = 'none';
      document.getElementById('modalOverlay').style.display = 'none';
      renderProducts();
    }

    document.getElementById('searchInput').addEventListener('input', filterProducts);
    document.addEventListener('DOMContentLoaded', fetchProducts);
  </script>
</body>
</html>
