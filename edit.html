<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>محرر كاتالوج GitHub</title>
  <style>
    body { font-family: sans-serif; direction: rtl; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    td[contenteditable] { background-color: #fff8dc; }
    button, select { padding: 6px 12px; margin: 5px; }
  </style>
</head>
<body>

<h2>📋 محرر كاتالوج GitHub</h2>

<label>اختر الملف:</label>
<select id="fileSelect">
  <option value="test.md">test.md (افتراضي)</option>
  <option value="abc.md">abc.md</option>
  <option value="lcd.md">lcd.md</option>
</select>
<button onclick="loadFile()">📥 تحميل</button>
<button onclick="addRow()">➕ إضافة صف</button>
<button onclick="saveFile()">💾 حفظ التعديلات</button>

<table id="catalogTable">
  <thead>
    <tr><th>الفئة</th><th>الصنف</th><th>السعر</th><th>رابط الصورة</th><th>حذف</th></tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
const username = "mohammad-shehadeh";
const repo = "price";
const token = "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"; // ⚠️ عدّله لاحقًا

function addRow(c = "", i = "", p = "", l = "") {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td contenteditable="true">${c}</td>
    <td contenteditable="true">${i}</td>
    <td contenteditable="true">${p}</td>
    <td contenteditable="true">${l}</td>
    <td><button onclick="this.closest('tr').remove();">🗑️</button></td>
  `;
  document.getElementById("tableBody").appendChild(row);
}

function getMarkdownFromTable() {
  const rows = document.querySelectorAll("#tableBody tr");
  return Array.from(rows).map(row => {
    return Array.from(row.querySelectorAll("td")).slice(0, 4)
      .map(cell => cell.innerText.trim()).join("/");
  }).join("\n");
}

async function loadFile() {
  const filename = document.getElementById("fileSelect").value;
  const url = `https://api.github.com/repos/${username}/${repo}/contents/${filename}`;
  const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
  const data = await res.json();
  const content = atob(data.content);

  document.getElementById("tableBody").innerHTML = "";
  content.trim().split("\n").forEach(line => {
    const [c, i, p, l] = line.split("/");
    addRow(c || "", i || "", p || "", l || "");
  });
}

async function saveFile() {
  const filename = document.getElementById("fileSelect").value;
  const url = `https://api.github.com/repos/${username}/${repo}/contents/${filename}`;
  const newContent = getMarkdownFromTable();
  const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
  const data = await res.json();

  const saveRes = await fetch(url, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Authorization: `token ${token}`
    },
    body: JSON.stringify({
      message: "تحديث من المحرر الجدولي",
      content: btoa(unescape(encodeURIComponent(newContent))),
      sha: data.sha
    })
  });

  if (saveRes.ok) {
    alert("✅ تم حفظ التعديلات!");
  } else {
    alert("❌ حدث خطأ أثناء الحفظ.");
  }
}

// تحميل الملف الافتراضي عند بداية التشغيل
window.onload = loadFile;
</script>

</body>
</html>
